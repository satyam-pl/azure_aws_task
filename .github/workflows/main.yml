name: Deploy Java Web App

on:
  workflow_dispatch: # Manually triggered workflow

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Ask for Cloud Provider
        id: provider
        run: |
          echo "::set-output name=provider::azure"
          
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Install Azure CLI
        uses: azure/CLI@v1
        with:
          azcliversion: 2.30.0 # You can specify the version you need

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "e12a2d0e-c7a8-497a-9c6a-f6feb27b10ac",
              "clientSecret": "~Ik8Q~u1dpSqwite8M6b-y4doLRhIEZPVpcmFcx4",
              "subscriptionId": "fafa58df-5f3a-4423-91ba-552d42b280dd",
              "tenantId": "ce3685eb-9b4e-4652-a942-7ea5cda9e6c0"
            }

      - name: Terraform Init & Apply
        run: |
          provider=${{ steps.provider.outputs.provider }}
          if [ "$provider" = "aws" ]; then
            cd "${{ github.workspace }}/aws" || exit 1
          elif [ "$provider" = "azure" ]; then
            cd "${{ github.workspace }}/azure" || exit 1
          else
            echo "Invalid provider selected. Please choose 'aws' or 'azure'."
            exit 1
          fi
          terraform init
          terraform apply -auto-approve
        working-directory: ${{ steps.provider.outputs.provider }}

      - name: Deploy Java Web App to Azure
        if: ${{ steps.provider.outputs.provider == 'azure' }}
        run: |
          cd java-web-app
          mvn clean install
          # Adjust the deploy command as per your specific deployment process
          # Example:
          # - az login
          # - az webapp create ...
          # - az webapp deploy ...

      - name: Upload artifact for deployment job
        if: ${{ steps.provider.outputs.provider == 'azure' }}
        uses: actions/upload-artifact@v2
        with:
          name: java-app
          path: '${{ github.workspace }}/java-web-app/target/*.jar'

      - name: Deploy to Azure Web App
        if: ${{ steps.provider.outputs.provider == 'azure' }}
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ steps.terraform.outputs.azure_web_app_name }}
          slot-name: 'Production'
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_D22C4CDE61E3434EA952E27D09520BD4 }}
          package: '*.jar'
