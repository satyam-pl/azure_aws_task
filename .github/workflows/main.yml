name: Deploy Java Web App

on:
  workflow_dispatch: # Manually triggered workflow

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Ask for Cloud Provider
        id: provider
        run: |
          echo "::set-output name=provider::azure"
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init & Apply
        run: |
          provider=${{ steps.provider.outputs.provider }}
          if [ "$provider" = "aws" ]; then
            cd "${{ github.workspace }}/aws" || exit 1
          elif [ "$provider" = "azure" ]; then
            cd "${{ github.workspace }}/azure" || exit 1
          else
            echo "Invalid provider selected. Please choose 'aws' or 'azure'."
            exit 1
          fi
          terraform init
          terraform apply -auto-approve
        working-directory: ${{ steps.provider.outputs.provider }}

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "55f5bbbf-df0a-49e0-b26f-08718b5d06b1",
              "clientSecret": "5Uz8Q~n30IgLwKr7YmFfv2o.cxmi1V9wtKbWWap6",
              "tenantId": "5a97c230-4719-47ba-a5bf-bf343a0926ec",
              "subscriptionId": "4b3d27d7-ff8a-428b-acaa-856bcf94bba6"
            }

      - name: Fetch Publish Profile
        run: |
          az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
          az webapp deployment list-publishing-profiles --name java-aws-azure-my-app-service6 --resource-group azure_aws_task6 --query "[?publishMethod=='FTP'].publishUrl" -o tsv > publishProfile.txt
          echo "AZUREAPPSERVICE_PUBLISHPROFILE=$(<publishProfile.txt)" >> $GITHUB_ENV

      - name: Deploy Java Web App to Azure
        if: ${{ steps.provider.outputs.provider == 'azure' }}
        run: |
          cd java-web-app
          mvn clean install
          # Adjust the deploy command as per your specific deployment process
          # Example:
          # - az login
          # - az webapp create ...
          # - az webapp deploy ...

      - name: Upload artifact for deployment job
        if: ${{ steps.provider.outputs.provider == 'azure' }}
        uses: actions/upload-artifact@v2
        with:
          name: java-app
          path: '${{ github.workspace }}/java-web-app/target/*.jar'

      - name: Deploy to Azure Web App
        if: ${{ steps.provider.outputs.provider == 'azure' }}
        uses: azure/webapps-deploy@v2
        with:
          app-name: 'java-aws-azure-my-app-service6'
          slot-name: 'Production'
          publish-profile: ${{ env.AZUREAPPSERVICE_PUBLISHPROFILE }}
          package: '*.jar'
